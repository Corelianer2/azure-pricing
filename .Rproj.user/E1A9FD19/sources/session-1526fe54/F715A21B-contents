install.packages("tidygeocoder")
install.packages("maps")

library("duckdb")
library("dplyr")
library("stringr")
library("ggplot2")
library(tidygeocoder)

world <- map_data("world")

con <- dbConnect(duckdb::duckdb(), dbdir = "azure_prices.duckdb")


#'  Azure Prices Dataset from Microsoft
#'
#' The prices are retail prices from the following API https://learn.microsoft.com/en-us/rest/api/cost-management/retail-prices/azure-retail-prices
#'
#' @format A data frame with 100 rows and 4 variables:
#' \describe{
#'   \item{meterName}{Unique identifier for each order (integer)}
#'   \item{type}{Meter consumption type. Other types are Reservation and Consumption.}
#'   \item{armRegionName}{	Azure Resource Manager region where the service is available. This version only supports prices on Commercial Cloud.}
#'   \item{location}{Azure data center where the resource is deployed}
#'   \item{serviceFamily}{Service family of the SKU}
#'   \item{serviceName}{Name of the service}
#'   \item{armSkuName}{SKU name registered in Azure}
#'    \item{term}{Term length for an Azure savings plan, associated with savingsPlan information.}
#' }
#' @source Generated for example purposes.
"azure_prices"

data <- dbReadTable(con, "azure_prices")

cleaned_data <- data |>
  mutate(
    effectiveStartDate = as.Date(effectiveStartDate),
    effectiveEndDate = as.Date(effectiveEndDate),
  )

# Display the structure of the data

linux_data <- cleaned_data |>
  filter(meterName == "D32ads v6") |>
  filter(type == "Consumption") |>
  filter(!endsWith(productName, "Windows")) |>
  arrange(desc(retailPrice)) |>
  geocode(location, method = "osm", lat = latitude, long = longitude)

View(linux_data)

windows_data <- cleaned_data |>
  filter(meterName == "D32ads v6") |>
  filter(type == "Consumption") |>
  filter(endsWith(productName, "Windows")) |>
  arrange(desc(retailPrice)) |>
  geocode(location, method = "osm", lat = latitude, long = longitude)



ggplot(linux_data, aes(longitude, latitude, fill = retailPrice)) +
  geom_polygon(color = "gray70") +
  theme_minimal() +
  labs(fill = "Retail Price",
       title = "Retail Price of D32ads v6 in Linux vs Windows",
       x = "Longitude",
       y = "Latitude")

ggplot() +
  geom_bar(data = linux_data, aes(x = armRegionName, y = retailPrice), stat = "identity", fill = "blue") +
  geom_text(data = linux_data, aes(x = armRegionName, y = retailPrice, label = armRegionName), vjust = -0.5) +
  geom_bar(data = windows_data, aes(x = armRegionName, y = retailPrice), stat = "identity", fill = "red", alpha = 0.5) +
  labs(title = "Price Comparison for D32ads v6",
       x = "Azure Region",
       y = "Retail Price") +
  theme_minimal()

# Plot world map with your data as points, colored by retailPrice
ggplot() +
  geom_polygon(data = world, aes(x = long, y = lat, group = group),
               fill = "lightblue", color = "gray70") +
  geom_point(data = linux_data,
             aes(x = longitude, y = latitude, color = retailPrice),
             size = 2, alpha = 0.8) +
  scale_color_viridis_c(option = "plasma") +  # Optional: nice color scale
  theme_minimal() +
  labs(title = "Hourly Retail Price of Linux D32ads VM on Azure by Location",
       color = "Retail Price")

# Plot the average of linux_data vs windows_data in a geom_bar plot
linux_avg <- linux_data %>%
  summarise(avg_retailPrice = mean(retailPrice, na.rm = TRUE))
windows_avg <- windows_data %>%
  summarise(avg_retailPrice = mean(retailPrice, na.rm = TRUE))

ggplot() +
  geom_bar(data = linux_avg, aes(x = "Linux", y = avg_retailPrice), stat = "identity", fill = "blue") +
  geom_bar(data = windows_avg, aes(x = "Windows", y = avg_retailPrice), stat = "identity", fill = "red", alpha = 0.5) +
  labs(title = "Average Retail Price of D32ads v6",
       x = "Operating System",
       y = "Average Retail Price") +
  theme_minimal()

# Compare the delta between linux_data and windows_data
linux_data <- linux_data %>%
  mutate(os = "Linux")

View(linux_data)

View(windows_data)
